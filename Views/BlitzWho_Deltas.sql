-- BlitzWho_Deltas
WITH MaxQueryDuration
AS (
SELECT   MIN(BlitzWho.ID) AS "MinID",
         MAX(BlitzWho.ID) AS "MaxID"
FROM     dbo.BlitzWho
GROUP BY BlitzWho.ServerName,
         BlitzWho.session_id,
         BlitzWho.database_name,
         BlitzWho.request_time,
         BlitzWho.start_time,
         BlitzWho.sql_handle
)
SELECT     BlitzWho.ID,
           BlitzWho.ServerName,
           BlitzWho.CheckDate,
           BlitzWho.elapsed_time,
           BlitzWho.session_id,
           BlitzWho.database_name,
           BlitzWho.query_text_snippet,
           BlitzWho.query_plan,
           BlitzWho.live_query_plan,
           BlitzWho.query_cost,
           BlitzWho.status,
           BlitzWho.wait_info,
           BlitzWho.top_session_waits,
           BlitzWho.blocking_session_id,
           BlitzWho.open_transaction_count,
           BlitzWho.is_implicit_transaction,
           BlitzWho.nt_domain,
           BlitzWho.host_name,
           BlitzWho.login_name,
           BlitzWho.nt_user_name,
           BlitzWho.program_name,
           BlitzWho.fix_parameter_sniffing,
           BlitzWho.client_interface_name,
           BlitzWho.login_time,
           BlitzWho.start_time,
           BlitzWho.request_time,
           BlitzWho.request_cpu_time,
           BlitzWho.degree_of_parallelism,
           BlitzWho.request_logical_reads,
           BlitzWho.Logical_Reads_MB,
           BlitzWho.request_writes,
           BlitzWho.Logical_Writes_MB,
           BlitzWho.request_physical_reads,
           BlitzWho.Physical_reads_MB,
           BlitzWho.session_cpu,
           BlitzWho.session_logical_reads,
           BlitzWho.session_logical_reads_MB,
           BlitzWho.session_physical_reads,
           BlitzWho.session_physical_reads_MB,
           BlitzWho.session_writes,
           BlitzWho.session_writes_MB,
           BlitzWho.tempdb_allocations_mb,
           BlitzWho.memory_usage,
           BlitzWho.estimated_completion_time,
           BlitzWho.percent_complete,
           BlitzWho.deadlock_priority,
           BlitzWho.transaction_isolation_level,
           BlitzWho.last_dop,
           BlitzWho.min_dop,
           BlitzWho.max_dop,
           BlitzWho.last_grant_kb,
           BlitzWho.min_grant_kb,
           BlitzWho.max_grant_kb,
           BlitzWho.last_used_grant_kb,
           BlitzWho.min_used_grant_kb,
           BlitzWho.max_used_grant_kb,
           BlitzWho.last_ideal_grant_kb,
           BlitzWho.min_ideal_grant_kb,
           BlitzWho.max_ideal_grant_kb,
           BlitzWho.last_reserved_threads,
           BlitzWho.min_reserved_threads,
           BlitzWho.max_reserved_threads,
           BlitzWho.last_used_threads,
           BlitzWho.min_used_threads,
           BlitzWho.max_used_threads,
           BlitzWho.grant_time,
           BlitzWho.requested_memory_kb,
           BlitzWho.grant_memory_kb,
           BlitzWho.is_request_granted,
           BlitzWho.required_memory_kb,
           BlitzWho.query_memory_grant_used_memory_kb,
           BlitzWho.ideal_memory_kb,
           BlitzWho.is_small,
           BlitzWho.timeout_sec,
           BlitzWho.resource_semaphore_id,
           BlitzWho.wait_order,
           BlitzWho.wait_time_ms,
           BlitzWho.next_candidate_for_memory_grant,
           BlitzWho.target_memory_kb,
           BlitzWho.max_target_memory_kb,
           BlitzWho.total_memory_kb,
           BlitzWho.available_memory_kb,
           BlitzWho.granted_memory_kb,
           BlitzWho.query_resource_semaphore_used_memory_kb,
           BlitzWho.grantee_count,
           BlitzWho.waiter_count,
           BlitzWho.timeout_error_count,
           BlitzWho.forced_grant_count,
           BlitzWho.workload_group_name,
           BlitzWho.resource_pool_name,
           BlitzWho.context_info,
           BlitzWho.query_hash,
           BlitzWho.query_plan_hash,
           BlitzWho.sql_handle,
           BlitzWho.plan_handle,
           BlitzWho.statement_start_offset,
           BlitzWho.statement_end_offset
FROM
           (
               SELECT ID,
                      ServerName,
                      CheckDate,
                      elapsed_time,
                      session_id,
                      database_name,
                      CAST(query_text AS NVARCHAR(1000)) AS "query_text_snippet",
                      query_plan,
                      live_query_plan,
                      query_cost,
                      status,
                      wait_info,
                      top_session_waits,
                      blocking_session_id,
                      open_transaction_count,
                      is_implicit_transaction,
                      nt_domain,
                      host_name,
                      login_name,
                      nt_user_name,
                      program_name,
                      fix_parameter_sniffing,
                      client_interface_name,
                      login_time,
                      start_time,
                      request_time,
                      request_cpu_time,
                      degree_of_parallelism,
                      request_logical_reads,
                      CAST(request_logical_reads AS MONEY) * 8 / 1024 AS "Logical_Reads_MB",
                      request_writes,
                      CAST(request_writes AS MONEY) * 8 / 1024 AS "Logical_Writes_MB",
                      request_physical_reads,
                      CAST(request_physical_reads AS MONEY) * 8 / 1024 AS "Physical_reads_MB",
                      session_cpu,
                      session_logical_reads,
                      CAST(session_logical_reads AS MONEY) * 8 / 1024 AS "session_logical_reads_MB",
                      session_physical_reads,
                      CAST(session_physical_reads AS MONEY) * 8 / 1024 AS "session_physical_reads_MB",
                      session_writes,
                      CAST(session_writes AS MONEY) * 8 / 1024 AS "session_writes_MB",
                      tempdb_allocations_mb,
                      memory_usage,
                      estimated_completion_time,
                      percent_complete,
                      deadlock_priority,
                      transaction_isolation_level,
                      last_dop,
                      min_dop,
                      max_dop,
                      last_grant_kb,
                      min_grant_kb,
                      max_grant_kb,
                      last_used_grant_kb,
                      min_used_grant_kb,
                      max_used_grant_kb,
                      last_ideal_grant_kb,
                      min_ideal_grant_kb,
                      max_ideal_grant_kb,
                      last_reserved_threads,
                      min_reserved_threads,
                      max_reserved_threads,
                      last_used_threads,
                      min_used_threads,
                      max_used_threads,
                      grant_time,
                      requested_memory_kb,
                      grant_memory_kb,
                      is_request_granted,
                      required_memory_kb,
                      query_memory_grant_used_memory_kb,
                      ideal_memory_kb,
                      is_small,
                      timeout_sec,
                      resource_semaphore_id,
                      wait_order,
                      wait_time_ms,
                      next_candidate_for_memory_grant,
                      target_memory_kb,
                      max_target_memory_kb,
                      total_memory_kb,
                      available_memory_kb,
                      granted_memory_kb,
                      query_resource_semaphore_used_memory_kb,
                      grantee_count,
                      waiter_count,
                      timeout_error_count,
                      forced_grant_count,
                      workload_group_name,
                      resource_pool_name,
                      context_info,
                      query_hash,
                      query_plan_hash,
                      sql_handle,
                      plan_handle,
                      statement_start_offset,
                      statement_end_offset
               FROM   dbo.BlitzWho AS BlitzWho_1
           ) AS BlitzWho
INNER JOIN MaxQueryDuration AS MaxQueryDuration_1
    ON BlitzWho.ID = MaxQueryDuration_1.MaxID;